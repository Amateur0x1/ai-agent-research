# MathModelAgent æ¶æ„è®¾è®¡æ ¸å¿ƒç»„ä»¶

## Q: MathModelAgent çš„æ¶æ„è®¾è®¡ç”±å“ªå‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼Ÿ

åŸºäºå¯¹ MathModelAgent çš„æ·±åº¦åˆ†æï¼Œæˆ‘å°†æ¶æ„åˆ†è§£ä¸º **8ä¸ªæ ¸å¿ƒç»„ä»¶**ï¼Œæ¯ä¸ªç»„ä»¶éƒ½æœ‰å…¶ç‹¬ç‰¹çš„èŒè´£å’Œä»·å€¼ã€‚

### ğŸ—ï¸ æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MathModelAgent æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ§  å¤§æ¨¡å‹å±‚ (LLM Layer)                                        â”‚
â”‚  â”œâ”€â”€ LiteLLM ç»Ÿä¸€æ¥å£ + LLMFactory å¤šæ¨¡å‹ç®¡ç†                    â”‚
â”‚  â””â”€â”€ Function Calling æ ‡å‡†åè®®                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¾ æ¶ˆæ¯å†å²ç®¡ç† (Message History Management)                    â”‚
â”‚  â”œâ”€â”€ æ™ºèƒ½å†…å­˜å‹ç¼© + å·¥å…·è°ƒç”¨å®Œæ•´æ€§ä¿æŠ¤                           â”‚
â”‚  â””â”€â”€ å¯¹è¯çŠ¶æ€ç»´æŠ¤                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¤– å¤šæ™ºèƒ½ä½“ç¼–æ’ (Multi-Agent Orchestration)                    â”‚
â”‚  â”œâ”€â”€ 4ä¸ªä¸“ä¸šåŒ– Agent + çº¿æ€§å·¥ä½œæµ                               â”‚
â”‚  â””â”€â”€ Agent é—´æ•°æ®ä¼ é€’                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”§ å·¥å…·æ‰§è¡Œç³»ç»Ÿ (Tool Execution System)                        â”‚
â”‚  â”œâ”€â”€ åŒæ¨¡å¼ä»£ç è§£é‡Šå™¨ + æ–‡çŒ®æœç´¢                                â”‚
â”‚  â””â”€â”€ å¼‚æ­¥æ‰§è¡Œ + é”™è¯¯é‡è¯•                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“‹ ä»»åŠ¡æµç¨‹æ§åˆ¶ (Task Flow Control)                            â”‚
â”‚  â”œâ”€â”€ Flows ç±»ç®¡ç† + åŒé˜¶æ®µæµç¨‹                                 â”‚
â”‚  â””â”€â”€ åŠ¨æ€æµç¨‹ç”Ÿæˆ                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŒ å®æ—¶é€šä¿¡ç³»ç»Ÿ (Real-time Communication)                      â”‚
â”‚  â”œâ”€â”€ WebSocket + Redis æ¶ˆæ¯é˜Ÿåˆ—                                â”‚
â”‚  â””â”€â”€ çŠ¶æ€å¹¿æ’­æœºåˆ¶                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¨ æ¨¡æ¿åŒ–ç³»ç»Ÿ (Template System)                                â”‚
â”‚  â”œâ”€â”€ Prompt æ¨¡æ¿ + è®ºæ–‡æ ¼å¼æ¨¡æ¿                                â”‚
â”‚  â””â”€â”€ TOML é…ç½®é©±åŠ¨                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš¡ å¼‚å¸¸å¤„ç†ä¸ç›‘æ§ (Error Handling & Monitoring)                â”‚
â”‚  â”œâ”€â”€ å¤šå±‚é‡è¯•æœºåˆ¶ + æ™ºèƒ½é™çº§                                   â”‚
â”‚  â””â”€â”€ æ—¥å¿—è·Ÿè¸ªç³»ç»Ÿ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. ğŸ§  å¤§æ¨¡å‹å±‚ (LLM Layer)

### æ ¸å¿ƒèŒè´£
- **æ¨¡å‹æŠ½è±¡**: ç»Ÿä¸€ä¸åŒ LLM çš„æ¥å£å·®å¼‚
- **Function Calling**: æ ‡å‡†åŒ–å·¥å…·è°ƒç”¨åè®®
- **å¤šæ¨¡å‹ç®¡ç†**: ä¸ºä¸åŒ Agent åˆ†é…æœ€é€‚åˆçš„æ¨¡å‹

### æŠ€æœ¯å®ç°
```python
# LLM ç»Ÿä¸€æ¥å£
class LLM:
    async def chat(self, history: list, tools: list = None, tool_choice: str = "auto"):
        return await litellm.achat(
            model=self.model,  # gpt-4o, claude-3.5-sonnet, etc.
            messages=history,
            tools=tools,       # Function Calling å·¥å…·å®šä¹‰
            tool_choice=tool_choice
        )

# å¤šæ¨¡å‹å·¥å‚
class LLMFactory:
    def get_all_llms(self) -> tuple[LLM, LLM, LLM, LLM]:
        return coordinator_llm, modeler_llm, coder_llm, writer_llm
```

### è®¾è®¡äº®ç‚¹
- **LiteLLM é›†æˆ**: æ”¯æŒ 100+ æ¨¡å‹æä¾›å•†
- **ä¸“ä¸šåŒ–åˆ†å·¥**: æ¯ä¸ª Agent ä½¿ç”¨æœ€é€‚åˆçš„æ¨¡å‹
- **æ ‡å‡†åè®®**: åŸºäº OpenAI Function Calling æ ‡å‡†

---

## 2. ğŸ’¾ æ¶ˆæ¯å†å²ç®¡ç† (Message History Management)

### æ ¸å¿ƒèŒè´£
- **æ™ºèƒ½å‹ç¼©**: é˜²æ­¢ä¸Šä¸‹æ–‡è¶…é™çš„åŒæ—¶ä¿ç•™å…³é”®ä¿¡æ¯
- **å®Œæ•´æ€§ä¿æŠ¤**: ç¡®ä¿å·¥å…·è°ƒç”¨åºåˆ—ä¸è¢«ç ´å
- **çŠ¶æ€ç»´æŠ¤**: ç®¡ç†å¯¹è¯çš„è¿ç»­æ€§

### æŠ€æœ¯å®ç°
```python
class Agent:
    async def clear_memory(self):
        if len(self.chat_history) > self.max_memory:
            # 1. æ‰¾åˆ°å®‰å…¨çš„ä¿ç•™ç‚¹
            safe_point = self._find_safe_preserve_point()
            
            # 2. ä½¿ç”¨ LLM æ€»ç»“å†å²
            summary = await simple_chat(self.model, summary_prompt)
            
            # 3. é‡æ„å†å²: ç³»ç»Ÿæ¶ˆæ¯ + æ€»ç»“ + æœ€è¿‘æ¶ˆæ¯
            self.chat_history = [system_msg, summary_msg, ...recent_msgs]
    
    def _is_safe_cut_point(self, start_idx: int) -> bool:
        # ç¡®ä¿ä¸ä¼šç ´å tool_calls å’Œ tool çš„é…å¯¹å…³ç³»
        pass
```

### è®¾è®¡äº®ç‚¹
- **æ™ºèƒ½å‹ç¼©ç®—æ³•**: åŸºäº LLM çš„å†å²æ€»ç»“
- **å·¥å…·è°ƒç”¨ä¿æŠ¤**: é˜²æ­¢æ¶ˆæ¯åºåˆ—è¢«ç ´å
- **å¤šå±‚å®¹é”™**: ä¸»ç­–ç•¥å¤±è´¥æ—¶çš„å®‰å…¨é™çº§

---

## 3. ğŸ¤– å¤šæ™ºèƒ½ä½“ç¼–æ’ (Multi-Agent Orchestration)

### æ ¸å¿ƒèŒè´£
- **ä¸“ä¸šåŒ–åˆ†å·¥**: 4ä¸ª Agent å„å¸å…¶èŒ
- **æ•°æ®ä¼ é€’**: Agent é—´çš„æ ‡å‡†åŒ–é€šä¿¡
- **æµç¨‹æ§åˆ¶**: çº¿æ€§å·¥ä½œæµçš„æ‰§è¡Œç®¡ç†

### Agent èŒè´£åˆ†è§£
```python
# 1. CoordinatorAgent - é—®é¢˜ç†è§£
input: ç”¨æˆ·åŸå§‹é—®é¢˜
output: ç»“æ„åŒ– JSON é—®é¢˜

# 2. ModelerAgent - æ•°å­¦å»ºæ¨¡  
input: ç»“æ„åŒ–é—®é¢˜
output: å»ºæ¨¡æ–¹æ¡ˆ JSON

# 3. CoderAgent - ä»£ç å®ç°
input: å»ºæ¨¡æ–¹æ¡ˆ
output: ä»£ç æ‰§è¡Œç»“æœ + å›¾ç‰‡

# 4. WriterAgent - è®ºæ–‡æ’°å†™
input: ä»£ç ç»“æœ
output: å­¦æœ¯è®ºæ–‡ç« èŠ‚
```

### å·¥ä½œæµç¼–æ’
```python
class MathModelWorkFlow:
    async def execute(self, problem: Problem):
        # çº¿æ€§æµæ°´çº¿æ‰§è¡Œ
        coordinator_response = await coordinator_agent.run(problem.ques_all)
        modeler_response = await modeler_agent.run(coordinator_response)
        
        # å¾ªç¯å¤„ç†æ¯ä¸ªå­é—®é¢˜
        for subtask in solution_flows:
            coder_response = await coder_agent.run(subtask)
            writer_response = await writer_agent.run(coder_response)
```

### è®¾è®¡äº®ç‚¹
- **æ— æ¡†æ¶è®¾è®¡**: é¿å… Agent æ¡†æ¶çš„å¤æ‚æ€§
- **æ ‡å‡†åŒ–é€šä¿¡**: é€šè¿‡ Pydantic æ¨¡å‹å®šä¹‰æ•°æ®ç»“æ„
- **ä¸“ä¸šåŒ–ä¼˜åŒ–**: æ¯ä¸ª Agent ä¸“æ³¨ç‰¹å®šé¢†åŸŸ

---

## 4. ğŸ”§ å·¥å…·æ‰§è¡Œç³»ç»Ÿ (Tool Execution System)

### æ ¸å¿ƒèŒè´£
- **ä»£ç æ‰§è¡Œ**: æ”¯æŒæœ¬åœ°å’Œäº‘ç«¯ä¸¤ç§æ¨¡å¼
- **æ–‡çŒ®æœç´¢**: é›†æˆå­¦æœ¯æ•°æ®åº“
- **å¼‚æ­¥æ‰§è¡Œ**: æ”¯æŒé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡

### åŒæ¨¡å¼ä»£ç æ‰§è¡Œ
```python
# æœ¬åœ°æ¨¡å¼ - LocalCodeInterpreter
class LocalCodeInterpreter:
    async def execute_code(self, code: str):
        # åŸºäº Jupyter Kernel æ‰§è¡Œ
        await self.kernel_client.execute(code)
        return self._collect_outputs()

# äº‘ç«¯æ¨¡å¼ - E2BCodeInterpreter  
class E2BCodeInterpreter:
    async def execute_code(self, code: str):
        # åœ¨ E2B æ²™ç›’ä¸­æ‰§è¡Œ
        result = await self.sandbox.run_code(code)
        return self._process_result(result)
```

### å·¥å…·é›†æˆæ¶æ„
```python
# å·¥å…·å®šä¹‰
tools = [
    {
        "name": "execute_code",
        "description": "æ‰§è¡ŒPythonä»£ç ",
        "parameters": {...}
    },
    {
        "name": "search_papers", 
        "description": "æœç´¢å­¦æœ¯è®ºæ–‡",
        "parameters": {...}
    }
]
```

### è®¾è®¡äº®ç‚¹
- **ç¯å¢ƒéš”ç¦»**: å®‰å…¨çš„ä»£ç æ‰§è¡Œç¯å¢ƒ
- **æ™ºèƒ½é‡è¯•**: åŸºäºé”™è¯¯åˆ†æçš„è‡ªåŠ¨é‡è¯•
- **ç»“æœä¿å­˜**: Jupyter Notebook æ ¼å¼ä¿å­˜

---

## 5. ğŸ“‹ ä»»åŠ¡æµç¨‹æ§åˆ¶ (Task Flow Control)

### æ ¸å¿ƒèŒè´£
- **æµç¨‹å®šä¹‰**: ç®¡ç†å¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡
- **åŠ¨æ€ç”Ÿæˆ**: æ ¹æ®é—®é¢˜æ•°é‡åŠ¨æ€è°ƒæ•´æµç¨‹
- **æ¨¡æ¿é›†æˆ**: ç»“åˆè®ºæ–‡æ¨¡æ¿ç”Ÿæˆä»»åŠ¡

### åŒé˜¶æ®µæµç¨‹è®¾è®¡
```python
class Flows:
    def get_solution_flows(self, modeler_response):
        # é˜¶æ®µ1: æ±‚è§£æµç¨‹
        return {
            "eda": {"coder_prompt": "æ•°æ®åˆ†æ..."},
            "ques1": {"coder_prompt": f"æ±‚è§£é—®é¢˜1: {modeler_response.ques1}"},
            "ques2": {"coder_prompt": f"æ±‚è§£é—®é¢˜2: {modeler_response.ques2}"},
            "sensitivity_analysis": {"coder_prompt": "æ•æ„Ÿæ€§åˆ†æ..."}
        }
    
    def get_write_flows(self, user_output, config_template):
        # é˜¶æ®µ2: å†™ä½œæµç¨‹
        return {
            "firstPage": "æ’°å†™å°é¢ã€æ‘˜è¦ã€å…³é”®è¯",
            "RepeatQues": "æ’°å†™é—®é¢˜é‡è¿°",
            "analysisQues": "æ’°å†™é—®é¢˜åˆ†æ",
            ...
        }
```

### è®¾è®¡äº®ç‚¹
- **åŠ¨æ€é€‚åº”**: æ ¹æ®é—®é¢˜æ•°é‡è‡ªåŠ¨è°ƒæ•´
- **æ¨¡æ¿é©±åŠ¨**: ç»“åˆé…ç½®æ¨¡æ¿ç”Ÿæˆä»»åŠ¡
- **çŠ¶æ€ç®¡ç†**: è·Ÿè¸ªæ¯ä¸ªæ­¥éª¤çš„æ‰§è¡ŒçŠ¶æ€

---

## 6. ğŸŒ å®æ—¶é€šä¿¡ç³»ç»Ÿ (Real-time Communication)

### æ ¸å¿ƒèŒè´£
- **è¿›åº¦æ¨é€**: å®æ—¶å‘å‰ç«¯æ¨é€ä»»åŠ¡è¿›åº¦
- **çŠ¶æ€åŒæ­¥**: è·¨è¿›ç¨‹çš„çŠ¶æ€åŒæ­¥
- **ç”¨æˆ·åé¦ˆ**: åŠæ—¶çš„é”™è¯¯å’ŒæˆåŠŸé€šçŸ¥

### é€šä¿¡æ¶æ„
```python
# åç«¯æ¶ˆæ¯å‘å¸ƒ
await redis_manager.publish_message(
    task_id,
    SystemMessage(content="ä»£ç æ‰‹å¼€å§‹æ±‚è§£é—®é¢˜1", type="info")
)

# å‰ç«¯æ¶ˆæ¯è®¢é˜…
const ws = new WebSocket(`ws://localhost:8000/ws/${taskId}`)
ws.onmessage = (event) => {
    const message = JSON.parse(event.data)
    updateUI(message)
}
```

### æ¶ˆæ¯ç±»å‹è®¾è®¡
```python
class SystemMessage(BaseModel):
    content: str
    type: Literal["info", "error", "success"] = "info"

class InterpreterMessage(BaseModel):
    input: dict  # ä»£ç æ‰§è¡Œè¾“å…¥

class WriterMessage(BaseModel):
    input: dict  # å†™ä½œè¾“å…¥
```

### è®¾è®¡äº®ç‚¹
- **WebSocket + Redis**: é«˜æ•ˆçš„å®æ—¶é€šä¿¡
- **ç±»å‹åŒ–æ¶ˆæ¯**: ç»“æ„åŒ–çš„æ¶ˆæ¯æ ¼å¼
- **çŠ¶æ€å¹¿æ’­**: æ”¯æŒå¤šå®¢æˆ·ç«¯åŒæ­¥

---

## 7. ğŸ¨ æ¨¡æ¿åŒ–ç³»ç»Ÿ (Template System)

### æ ¸å¿ƒèŒè´£
- **Prompt æ¨¡æ¿**: æ ‡å‡†åŒ–çš„ Agent æç¤ºè¯
- **è®ºæ–‡æ¨¡æ¿**: ç¬¦åˆæ¯”èµ›æ ‡å‡†çš„è®ºæ–‡æ ¼å¼
- **é…ç½®ç®¡ç†**: é€šè¿‡é…ç½®æ–‡ä»¶é©±åŠ¨è¡Œä¸º

### æ¨¡æ¿é…ç½®
```toml
# config/md_template.toml
[template]
firstPage = """
# {title}

## æ‘˜è¦
{abstract}

## å…³é”®è¯  
{keywords}
"""

eda = """
## æ•°æ®åˆ†æ

### æ•°æ®æ¦‚è¿°
{data_overview}

### å¯è§†åŒ–åˆ†æ
{visualization}
"""
```

### Prompt æ¨¡æ¿
```python
MODELER_PROMPT = """
roleï¼šä½ æ˜¯ä¸€åæ•°å­¦å»ºæ¨¡ç»éªŒä¸°å¯Œçš„å»ºæ¨¡æ‰‹
taskï¼šæ ¹æ®ç”¨æˆ·è¦æ±‚å»ºç«‹æ•°å­¦æ¨¡å‹æ±‚è§£é—®é¢˜
skillï¼šç†Ÿç»ƒæŒæ¡å„ç§æ•°å­¦å»ºæ¨¡çš„æ¨¡å‹å’Œæ€è·¯
outputï¼šä»¥JSONæ ¼å¼è¾“å‡ºå»ºæ¨¡æ€è·¯å’Œæ¨¡å‹æ–¹æ¡ˆ
"""
```

### è®¾è®¡äº®ç‚¹
- **TOML é…ç½®**: äººç±»å‹å¥½çš„é…ç½®æ ¼å¼
- **æ¨¡æ¿ç»§æ‰¿**: æ”¯æŒæ¨¡æ¿çš„ç»„åˆå’Œæ‰©å±•
- **åŠ¨æ€æ›¿æ¢**: è¿è¡Œæ—¶åŠ¨æ€å¡«å……æ¨¡æ¿å˜é‡

---

## 8. âš¡ å¼‚å¸¸å¤„ç†ä¸ç›‘æ§ (Error Handling & Monitoring)

### æ ¸å¿ƒèŒè´£
- **å¤šå±‚é‡è¯•**: ä¸åŒçº§åˆ«çš„é‡è¯•ç­–ç•¥
- **æ™ºèƒ½é™çº§**: å¤±è´¥æ—¶çš„å®‰å…¨å›é€€
- **å…¨é“¾è·¯ç›‘æ§**: å®Œæ•´çš„æ—¥å¿—å’Œè·Ÿè¸ª

### é‡è¯•æœºåˆ¶è®¾è®¡
```python
class CoderAgent:
    async def run(self, prompt: str):
        retry_count = 0
        while retry_count < self.max_retries:
            try:
                result = await self.code_interpreter.execute_code(code)
                if error_occurred:
                    # æ™ºèƒ½åæ€é‡è¯•
                    reflection_prompt = get_reflection_prompt(error, code)
                    await self.append_chat_history({"role": "user", "content": reflection_prompt})
                    retry_count += 1
                    continue
                else:
                    return result
            except Exception as e:
                retry_count += 1
                continue
```

### ç›‘æ§ä½“ç³»
```python
# æ—¥å¿—ç³»ç»Ÿ
logger.info(f"{self.__class__.__name__}:å¼€å§‹:æ‰§è¡Œå¯¹è¯")
logger.error(f"æ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯: {str(e)}")

# çŠ¶æ€è·Ÿè¸ª
await redis_manager.publish_message(
    task_id,
    SystemMessage(content="è¶…è¿‡æœ€å¤§å°è¯•æ¬¡æ•°", type="error")
)
```

### è®¾è®¡äº®ç‚¹
- **åˆ†å±‚é‡è¯•**: Agent çº§åˆ«å’Œå·¥å…·çº§åˆ«çš„ä¸åŒç­–ç•¥
- **æ™ºèƒ½åˆ†æ**: åŸºäºé”™è¯¯ä¿¡æ¯çš„æ™ºèƒ½é‡è¯•
- **ç”¨æˆ·å‹å¥½**: åŠæ—¶çš„é”™è¯¯åé¦ˆå’ŒçŠ¶æ€æç¤º

---

## ğŸ¯ æ¶æ„è®¾è®¡çš„æ ¸å¿ƒä¼˜åŠ¿

### 1. **æ¨¡å—åŒ–è®¾è®¡**
- æ¯ä¸ªç»„ä»¶èŒè´£å•ä¸€ï¼Œè¾¹ç•Œæ¸…æ™°
- æ˜“äºæµ‹è¯•ã€ç»´æŠ¤å’Œæ‰©å±•
- æ”¯æŒç»„ä»¶çº§åˆ«çš„ä¼˜åŒ–å’Œæ›¿æ¢

### 2. **ä¸“ä¸šåŒ–ä¸é€šç”¨æ€§çš„å¹³è¡¡**  
- é’ˆå¯¹æ•°å­¦å»ºæ¨¡é¢†åŸŸæ·±åº¦ä¼˜åŒ–
- ä¿æŒæ¶æ„çš„é€šç”¨æ€§ï¼Œå¯æ‰©å±•åˆ°å…¶ä»–é¢†åŸŸ

### 3. **æ— æ¡†æ¶çš„è‡ªä¸»å®ç°**
- é¿å…æ¡†æ¶çš„å¤æ‚æ€§å’Œé™åˆ¶
- å®Œå…¨æ§åˆ¶æ‰§è¡Œé€»è¾‘å’Œæ€§èƒ½ä¼˜åŒ–
- å‡å°‘å¤–éƒ¨ä¾èµ–å’Œæ½œåœ¨é£é™©

### 4. **å·¥ç¨‹åŒ–çš„å®è·µ**
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- å®æ—¶çš„çŠ¶æ€åé¦ˆå’Œç”¨æˆ·ä½“éªŒ
- æ ‡å‡†åŒ–çš„é…ç½®å’Œæ¨¡æ¿ç®¡ç†

### 5. **å¯æ‰©å±•çš„æ¶æ„**
- æ˜“äºæ·»åŠ æ–°çš„ Agent ç±»å‹
- æ”¯æŒæ–°çš„å·¥å…·å’Œé›†æˆ
- æ¨¡æ¿åŒ–çš„å®šåˆ¶èƒ½åŠ›

---

## ğŸš€ æ€»ç»“

MathModelAgent çš„æ¶æ„è®¾è®¡ä½“ç°äº†ç°ä»£ AI ç³»ç»Ÿçš„**å·¥ç¨‹åŒ–æ€ç»´**ï¼š

1. **åŸºç¡€è®¾æ–½å±‚**: å¤§æ¨¡å‹æ¥å£ã€æ¶ˆæ¯ç®¡ç†ã€å®æ—¶é€šä¿¡
2. **ä¸šåŠ¡é€»è¾‘å±‚**: å¤šæ™ºèƒ½ä½“ç¼–æ’ã€å·¥å…·æ‰§è¡Œã€æµç¨‹æ§åˆ¶  
3. **ç”¨æˆ·ä½“éªŒå±‚**: æ¨¡æ¿åŒ–ç³»ç»Ÿã€å¼‚å¸¸å¤„ç†ã€çŠ¶æ€åé¦ˆ

è¿™ç§åˆ†å±‚æ¶æ„ä½¿å¾—ç³»ç»Ÿæ—¢å…·å¤‡äº†å¼ºå¤§çš„åŠŸèƒ½æ€§ï¼Œåˆä¿æŒäº†è‰¯å¥½çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ï¼Œæ˜¯å¤šæ™ºèƒ½ä½“ç³»ç»Ÿè®¾è®¡çš„ä¼˜ç§€èŒƒä¾‹ã€‚